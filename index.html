<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layakari Polyrhythm Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .grid-cell {
            transition: background-color 0.05s ease;
        }
        .grid-cell.active {
            background-color: rgb(234, 179, 8) !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold mb-2 text-center">Layakari Polyrhythm Trainer</h1>

        <div id="audioHint" class="text-center mb-6">
            <button id="enableAudioBtn" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold rounded-lg">
                ðŸ”Š Tap to Enable Audio (You'll hear a beep)
            </button>
        </div>

        <!-- Controls Section -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 space-y-6">
            <!-- Rhythm Parameters -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Bols (N)</label>
                    <input type="number" id="bols" min="1" max="10" value="4"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Beats (D)</label>
                    <input type="number" id="beats" min="1" max="10" value="3"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Tempo (BPM)</label>
                    <input type="number" id="tempo" min="10" max="300" value="30"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                </div>
            </div>

            <!-- Volume Controls -->
            <div class="space-y-3">
                <h3 class="text-sm font-semibold text-gray-300 uppercase tracking-wide">Volume Mix</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm mb-1 flex justify-between">
                            <span>Beat</span>
                            <span id="beatVolLabel" class="text-gray-400">50%</span>
                        </label>
                        <input type="range" id="beatVol" min="0" max="100" value="50"
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm mb-1 flex justify-between">
                            <span>Bol</span>
                            <span id="bolVolLabel" class="text-gray-400">0%</span>
                        </label>
                        <input type="range" id="bolVol" min="0" max="100" value="0"
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm mb-1 flex justify-between">
                            <span>Laghu</span>
                            <span id="subdivVolLabel" class="text-gray-400">20%</span>
                        </label>
                        <input type="range" id="subdivVol" min="0" max="100" value="20"
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-gray-500">
                    </div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex flex-wrap gap-3 justify-center">
                <button id="playBtn"
                        class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors">
                    â–¶ Play
                </button>
            </div>
        </div>

        <!-- Visualizer Section -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Rhythm Visualizer</h2>
            <!-- Desktop: horizontal scrolling -->
            <div class="hidden md:block overflow-x-auto">
                <div id="gridDesktop" class="inline-flex gap-0"></div>
            </div>
            <!-- Mobile: multiple rows -->
            <div id="gridMobile" class="md:hidden space-y-2"></div>
            <div class="mt-4 flex flex-wrap gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-teal-500 rounded-full"></div>
                    <span>Bol</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-purple-500 rounded-full"></div>
                    <span>Beat + Bol</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 border-4 border-blue-500"></div>
                    <span>Beat Start</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-yellow-500"></div>
                    <span>Current Position</span>
                </div>
            </div>
        </div>

        <!-- iPhone Silent Mode Warning -->
        <div class="bg-orange-900/50 border-2 border-orange-500 rounded-lg p-4 mt-6 text-center">
            <p class="text-orange-200 font-semibold">ðŸ“± iPhone/iPad: No audio? Turn OFF Silent Mode</p>
        </div>

        <!-- Practice Instructions -->
        <div class="bg-gray-800 rounded-lg p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">How to Practice</h2>
            <div class="space-y-4 text-gray-300">
                <div class="flex gap-3">
                    <span class="text-blue-400 font-bold flex-shrink-0">Step 1:</span>
                    <p>Start with Bol volume at 0. Practice <span class="font-semibold text-white">Tali</span> (clap) on the beat.</p>
                </div>
                <div class="flex gap-3">
                    <span class="text-blue-400 font-bold flex-shrink-0">Step 2:</span>
                    <p>Practice saying the repeating number pattern (1, 1, 1, 2, 2, 2, ...) on laghu (tick), while clapping on the beat.</p>
                </div>
                <div class="flex gap-3">
                    <span class="text-blue-400 font-bold flex-shrink-0">Step 3:</span>
                    <p>Now increase the Bol sound. Say only the <span class="font-semibold text-white">first number</span> of each repetition along with the Bol sound. Continue clapping on beats. This is the layakari pattern!</p>
                </div>
                <div class="flex gap-3">
                    <span class="text-blue-400 font-bold flex-shrink-0">Step 4:</span>
                    <p>Replace the numbers with actual tabla bols (e.g., <span class="font-semibold text-white">Ti R Ki T</span> or <span class="font-semibold text-white">Dha Ge Na Tin</span>). Recite the bol sequence with repetition or first Bol only while maintaining the layakari pattern.</p>
                </div>
            </div>
        </div>

        <!-- Teacher Credit -->
        <div class="text-center mt-8 pb-6">
            <p class="text-gray-400 text-sm">
                Inspired by my tabla teacher Shri Satish Tare
                <a href="https://tablaniketan.com" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 underline">tablaniketan.com</a>
            </p>
        </div>
    </div>

    <script>
        // Audio Context and State
        let audioContext = null;
        let isPlaying = false;
        let currentBlock = 0;
        let totalBlocks = 0;
        let animationId = null;
        let nextNoteTime = 0;
        let startTime = 0;
        let scheduleAheadTime = 0.1;
        let lookahead = 25.0;
        let timerID = null;
        let blockDuration = 0;
        let bolBlocks = [];
        let beatBlocks = [];
        let audioUnlocked = false;

        // Gain Nodes
        let beatGain, bolGain, subdivGain;

        // DOM Elements
        const bolsInput = document.getElementById('bols');
        const beatsInput = document.getElementById('beats');
        const tempoInput = document.getElementById('tempo');
        const playBtn = document.getElementById('playBtn');
        const gridDesktop = document.getElementById('gridDesktop');
        const gridMobile = document.getElementById('gridMobile');
        const beatVolSlider = document.getElementById('beatVol');
        const bolVolSlider = document.getElementById('bolVol');
        const subdivVolSlider = document.getElementById('subdivVol');
        const beatVolLabel = document.getElementById('beatVolLabel');
        const bolVolLabel = document.getElementById('bolVolLabel');
        const subdivVolLabel = document.getElementById('subdivVolLabel');

        // Initialize Audio Context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Create gain nodes
                beatGain = audioContext.createGain();
                bolGain = audioContext.createGain();
                subdivGain = audioContext.createGain();

                beatGain.connect(audioContext.destination);
                bolGain.connect(audioContext.destination);
                subdivGain.connect(audioContext.destination);

                updateVolumes();
            }
            return audioContext;
        }

        // Play a test beep to verify audio is working
        function playTestBeep() {
            const ctx = audioContext;
            if (!ctx) return;

            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            osc.connect(gain);
            gain.connect(ctx.destination);

            osc.frequency.value = 880;
            gain.gain.value = 0.3;

            const now = ctx.currentTime;
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);

            osc.start(now);
            osc.stop(now + 0.3);
        }

        // Unlock audio on mobile (iOS Safari workaround)
        async function unlockAudio() {
            if (audioUnlocked) return Promise.resolve();

            const ctx = initAudio();

            try {
                // Create and play a silent buffer
                const buffer = ctx.createBuffer(1, 1, 22050);
                const source = ctx.createBufferSource();
                source.buffer = buffer;
                source.connect(ctx.destination);
                source.start(0);

                // Resume context - crucial for iOS
                await ctx.resume();

                audioUnlocked = true;
                console.log('Audio unlocked successfully, state:', ctx.state);

                // Play test beep
                playTestBeep();

                return Promise.resolve();
            } catch (err) {
                console.error('Failed to unlock audio:', err);
                return Promise.reject(err);
            }
        }

        // Explicit audio enable button handler
        const enableAudioBtn = document.getElementById('enableAudioBtn');
        if (enableAudioBtn) {
            enableAudioBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await unlockAudio();
                    const hint = document.getElementById('audioHint');
                    if (hint) {
                        hint.innerHTML = '<p class="text-green-400 text-sm">âœ“ Audio Enabled! You can now press Play.</p>';
                        setTimeout(() => {
                            hint.style.display = 'none';
                        }, 2000);
                    }
                } catch (err) {
                    alert('Failed to enable audio. Please check your phone is not on silent mode.');
                }
            });
        }

        // Sound Generation Functions
        function playBeat(time) {
            const ctx = initAudio();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();

            osc.type = 'sine';
            osc.frequency.setValueAtTime(900, time);
            osc.frequency.exponentialRampToValueAtTime(700, time + 0.1);

            gainNode.gain.setValueAtTime(0.8, time);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.15);

            osc.connect(gainNode);
            gainNode.connect(beatGain);

            osc.start(time);
            osc.stop(time + 0.15);
        }

        function playBol(time) {
            const ctx = initAudio();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();

            osc.type = 'sine';
            osc.frequency.setValueAtTime(150, time);
            osc.frequency.exponentialRampToValueAtTime(80, time + 0.15);

            gainNode.gain.setValueAtTime(1, time);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.2);

            osc.connect(gainNode);
            gainNode.connect(bolGain);

            osc.start(time);
            osc.stop(time + 0.2);
        }

        function playSubdivision(time) {
            const ctx = initAudio();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();

            osc.type = 'sine';
            osc.frequency.value = 1800;

            gainNode.gain.setValueAtTime(0.5, time);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.015);

            osc.connect(gainNode);
            gainNode.connect(subdivGain);

            osc.start(time);
            osc.stop(time + 0.015);
        }

        // Update volumes
        function updateVolumes() {
            if (!beatGain) return;

            beatGain.gain.value = beatVolSlider.value / 100;
            bolGain.gain.value = bolVolSlider.value / 100;
            subdivGain.gain.value = subdivVolSlider.value / 100;

            beatVolLabel.textContent = beatVolSlider.value + '%';
            bolVolLabel.textContent = bolVolSlider.value + '%';
            subdivVolLabel.textContent = subdivVolSlider.value + '%';
        }

        beatVolSlider.addEventListener('input', updateVolumes);
        bolVolSlider.addEventListener('input', updateVolumes);
        subdivVolSlider.addEventListener('input', updateVolumes);

        // Calculate polyrhythm pattern
        function calculatePattern() {
            const N = parseInt(bolsInput.value);
            const D = parseInt(beatsInput.value);

            // Simply use N * D for total blocks (no LCM)
            totalBlocks = N * D;
            const bolInterval = totalBlocks / N;
            const beatInterval = totalBlocks / D;

            bolBlocks = [];
            beatBlocks = [];

            for (let i = 0; i < totalBlocks; i++) {
                if (i % bolInterval === 0) bolBlocks.push(i);
                if (i % beatInterval === 0) beatBlocks.push(i);
            }

            return { N, D, totalBlocks, bolInterval, beatInterval };
        }

        // Helper function to create a cell
        function createCell(i, boxNumbers, bolInterval, beatInterval) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell relative';
            cell.style.width = '60px';
            cell.style.height = '60px';
            cell.dataset.index = i;

            // Determine bol number for this block
            const bolNum = Math.floor(i / bolInterval);
            const isBolStart = i % bolInterval === 0;
            const isBeatStart = i % beatInterval === 0;

            // Alternating bol background
            const bgColor = bolNum % 2 === 0 ? 'bg-gray-700' : 'bg-gray-600';
            cell.classList.add(bgColor);

            // Beat grouping border
            if (isBeatStart) {
                cell.style.borderLeft = '4px solid rgb(59, 130, 246)';
            } else {
                cell.style.borderLeft = '1px solid rgb(75, 85, 99)';
            }
            cell.style.borderTop = '1px solid rgb(75, 85, 99)';
            cell.style.borderBottom = '1px solid rgb(75, 85, 99)';
            cell.style.borderRight = '1px solid rgb(75, 85, 99)';

            // Event indicator dots
            const dotContainer = document.createElement('div');
            dotContainer.className = 'absolute top-1 left-1/2 transform -translate-x-1/2 flex gap-1';

            if (isBolStart && isBeatStart) {
                // Purple dot for coincidence
                const dot = document.createElement('div');
                dot.className = 'w-3 h-3 bg-purple-500 rounded-full';
                dotContainer.appendChild(dot);
            } else if (isBolStart) {
                // Teal dot for bol
                const dot = document.createElement('div');
                dot.className = 'w-3 h-3 bg-teal-500 rounded-full';
                dotContainer.appendChild(dot);
            }

            cell.appendChild(dotContainer);

            // Box number
            const number = document.createElement('div');
            number.className = 'absolute bottom-1 left-1/2 transform -translate-x-1/2 text-sm font-semibold text-gray-300';
            number.textContent = boxNumbers[i] || i + 1;
            cell.appendChild(number);

            return cell;
        }

        // Generate visual grid
        function generateGrid() {
            const { N, D, totalBlocks, bolInterval, beatInterval } = calculatePattern();
            gridDesktop.innerHTML = '';
            gridMobile.innerHTML = '';

            // Calculate box numbers based on the requirement
            const boxNumbers = [];
            for (let bolNum = 1; bolNum <= N; bolNum++) {
                const blocksInThisBol = Math.floor(totalBlocks / N);
                const extraBlocks = bolNum <= (totalBlocks % N) ? 1 : 0;
                const totalBlocksForBol = blocksInThisBol + extraBlocks;

                for (let j = 0; j < totalBlocksForBol; j++) {
                    boxNumbers.push(bolNum);
                }
            }

            // Generate DESKTOP grid (single row)
            for (let i = 0; i < totalBlocks; i++) {
                const cell = createCell(i, boxNumbers, bolInterval, beatInterval);
                gridDesktop.appendChild(cell);
            }

            // Generate MOBILE grid (multiple rows, one per beat)
            const blocksPerBeat = beatInterval;
            for (let beatNum = 0; beatNum < D; beatNum++) {
                const row = document.createElement('div');
                row.className = 'flex flex-col gap-2';

                // Add beat label
                const beatLabel = document.createElement('div');
                beatLabel.className = 'text-center text-xs text-gray-400';
                beatLabel.textContent = `Beat ${beatNum + 1}`;
                row.appendChild(beatLabel);

                const cellsContainer = document.createElement('div');
                cellsContainer.className = 'flex gap-0 justify-center';

                // Add blocks for this beat
                const startBlock = beatNum * blocksPerBeat;
                const endBlock = Math.min(startBlock + blocksPerBeat, totalBlocks);

                for (let i = startBlock; i < endBlock; i++) {
                    const cell = createCell(i, boxNumbers, bolInterval, beatInterval);
                    cellsContainer.appendChild(cell);
                }

                row.appendChild(cellsContainer);
                gridMobile.appendChild(row);
            }
        }

        // Scheduler for precise timing
        function scheduler() {
            const ctx = audioContext;
            while (nextNoteTime < ctx.currentTime + scheduleAheadTime) {
                scheduleNote(currentBlock, nextNoteTime);
                nextNote();
            }
            timerID = setTimeout(scheduler, lookahead);
        }

        function scheduleNote(blockIndex, time) {
            // Always play subdivision
            playSubdivision(time);

            // Play beat if this is a beat block
            if (beatBlocks.includes(blockIndex)) {
                playBeat(time);
            }

            // Play bol if this is a bol block
            if (bolBlocks.includes(blockIndex)) {
                playBol(time);
            }
        }

        function nextNote() {
            const bpm = parseInt(tempoInput.value);
            const secondsPerBeat = 60.0 / bpm;
            blockDuration = secondsPerBeat / (totalBlocks / parseInt(beatsInput.value));

            nextNoteTime += blockDuration;
            currentBlock = (currentBlock + 1) % totalBlocks;
        }

        // Visual animation
        function animate() {
            if (!isPlaying) return;

            const ctx = audioContext;
            const currentTime = ctx.currentTime;
            const elapsedTime = currentTime - startTime;
            const visualBlock = Math.floor(elapsedTime / blockDuration) % totalBlocks;

            // Update visual in both desktop and mobile grids
            const allCells = document.querySelectorAll('.grid-cell');
            allCells.forEach((cell) => {
                const cellIndex = parseInt(cell.dataset.index);
                if (cellIndex === visualBlock) {
                    cell.classList.add('active');
                } else {
                    cell.classList.remove('active');
                }
            });

            animationId = requestAnimationFrame(animate);
        }

        // Play function
        async function play() {
            if (isPlaying) return;

            // Unlock audio first (critical for iOS)
            await unlockAudio();
            const ctx = initAudio();

            // Aggressive resume for iOS
            if (ctx.state === 'suspended') {
                await ctx.resume();
            }

            // Double-check audio is ready
            if (ctx.state !== 'running') {
                console.warn('Audio context not running:', ctx.state);
                alert('Please tap the screen to enable audio, then press Play again.');
                return;
            }

            // Calculate block duration before starting
            const bpm = parseInt(tempoInput.value);
            const secondsPerBeat = 60.0 / bpm;
            blockDuration = secondsPerBeat / (totalBlocks / parseInt(beatsInput.value));

            isPlaying = true;
            currentBlock = 0;
            startTime = ctx.currentTime;
            nextNoteTime = ctx.currentTime;

            scheduler();
            animate();

            // Update button to show Stop
            playBtn.innerHTML = 'â–  Stop';
            playBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            playBtn.classList.add('bg-red-600', 'hover:bg-red-700');
        }

        // Stop function
        function stop() {
            if (!isPlaying) return;

            isPlaying = false;
            currentBlock = 0;

            if (timerID) {
                clearTimeout(timerID);
                timerID = null;
            }

            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            // Clear visual highlight in both grids
            const allCells = document.querySelectorAll('.grid-cell');
            allCells.forEach(cell => cell.classList.remove('active'));

            // Update button to show Play
            playBtn.innerHTML = 'â–¶ Play';
            playBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            playBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        }

        // Toggle play/stop
        async function togglePlay() {
            if (isPlaying) {
                stop();
            } else {
                await play();
            }
        }

        // Validation functions
        function validateInput(input, min, max) {
            let value = parseInt(input.value);
            if (isNaN(value) || value < min) {
                input.value = min;
            } else if (value > max) {
                input.value = max;
            }
        }

        // Event listeners
        playBtn.addEventListener('click', togglePlay);

        // Validate and regenerate grid when parameters change
        bolsInput.addEventListener('change', () => {
            validateInput(bolsInput, 1, 10);
            stop();
            generateGrid();
        });
        bolsInput.addEventListener('blur', () => {
            validateInput(bolsInput, 1, 10);
        });

        beatsInput.addEventListener('change', () => {
            validateInput(beatsInput, 1, 10);
            stop();
            generateGrid();
        });
        beatsInput.addEventListener('blur', () => {
            validateInput(beatsInput, 1, 10);
        });

        tempoInput.addEventListener('change', () => {
            validateInput(tempoInput, 10, 300);
        });
        tempoInput.addEventListener('blur', () => {
            validateInput(tempoInput, 10, 300);
        });

        // Initialize
        generateGrid();
    </script>
</body>
</html>
